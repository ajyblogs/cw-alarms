AWSTemplateFormatVersion: '2010-09-09'
Description: 'CloudFormation template to automatically pause and resume CloudWatch alarms for a Redshift cluster'

Parameters:
  RedshiftClusterName:
    Type: String
    Description: Name of the Redshift cluster whose alarms will be managed

Resources:
  # IAM Role for EventBridge to use AWS API actions
  EventBridgeRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonCloudWatchFullAccess

  # Schedule to disable Redshift alarms at 11:30 AM UTC
  DisableAlarmsSchedule:
    Type: AWS::Scheduler::Schedule
    Properties:
      Name: !Sub "${RedshiftClusterName}-disable-alarms-schedule"
      Description: "Schedule to disable CloudWatch alarms for Redshift cluster at 11:30 AM UTC"
      FlexibleTimeWindow:
        Mode: OFF
      ScheduleExpression: "cron(30 11 * * ? *)"
      ScheduleExpressionTimezone: "UTC"
      State: ENABLED
      Target:
        Arn: "arn:aws:scheduler:::aws-sdk:cloudwatch:disableAlarmActions"
        RoleArn: !GetAtt EventBridgeRole.Arn
        Input: !Sub |
          {
            "AlarmNames": [
              {
                "aws:rep:latest": [
                  {
                    "aws:sdk:cloudwatch:listAlarms": [
                      {
                        "AlarmNamePrefix": "${RedshiftClusterName}"
                      }
                    ],
                    "path": "$.MetricAlarms[*].AlarmName"
                  }
                ]
              }
            ]
          }

  # Schedule to enable Redshift alarms at 12:00 AM UTC
  EnableAlarmsSchedule:
    Type: AWS::Scheduler::Schedule
    Properties:
      Name: !Sub "${RedshiftClusterName}-enable-alarms-schedule"
      Description: "Schedule to enable CloudWatch alarms for Redshift cluster at 12:00 AM UTC"
      FlexibleTimeWindow:
        Mode: OFF
      ScheduleExpression: "cron(0 0 * * ? *)"
      ScheduleExpressionTimezone: "UTC"
      State: ENABLED
      Target:
        Arn: "arn:aws:scheduler:::aws-sdk:cloudwatch:enableAlarmActions"
        RoleArn: !GetAtt EventBridgeRole.Arn
        Input: !Sub |
          {
            "AlarmNames": [
              {
                "aws:rep:latest": [
                  {
                    "aws:sdk:cloudwatch:listAlarms": [
                      {
                        "AlarmNamePrefix": "${RedshiftClusterName}"
                      }
                    ],
                    "path": "$.MetricAlarms[*].AlarmName"
                  }
                ]
              }
            ]
          }

Outputs:
  DisableAlarmsScheduleArn:
    Description: ARN of the schedule that disables alarms
    Value: !GetAtt DisableAlarmsSchedule.Arn
  
  EnableAlarmsScheduleArn:
    Description: ARN of the schedule that enables alarms
    Value: !GetAtt EnableAlarmsSchedule.Arn